(function(){"use strict";var a;a=jQuery,window.WC_Jilt=function(){function b(){var b;this.params=window.wc_jilt_params,b=a("form.woocommerce-checkout, form.checkout"),b.length&&(b.on("focusin select2-open select2:open","input, select",function(a){return function(b){return a.persist_order_data(b)}}(this)),b.on("focusout select2-close select2:close","input, select",function(a){return function(b){return a.send_order_data(b)}}(this)),b.on("change",'[name="payment_method"]',function(a){return function(b){return a.send_chosen_payment_method(b)}}(this)),b.on("change",'[name="order_comments"]',function(a){return function(b){return a.send_order_note(b)}}(this)),a(window).on("unload visibilitychange",function(a){return function(){return a.send_order_data_before_unload()}}(this)))}return b.prototype.persist_order_data=function(b){var c;if(c=a(b.target),this.is_checkout_field(c))return c.val()?c.data("jilt-value",c.val()):void 0},b.prototype.send_chosen_payment_method=function(b){return a.ajax({method:"PATCH",url:this.params.endpoint+"/orders/"+this.params.order_id,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:{cart_token:this.params.cart_token,client_session:{chosen_payment_method:a(b.target).val()}}})},b.prototype.send_order_note=function(b){return a.ajax({method:"PUT",url:this.params.endpoint+"/orders/"+this.params.order_id,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:{cart_token:this.params.cart_token,note:a(b.target).val()}})},b.prototype.send_order_data=function(b){var c,d,e,f,g,h,i;if(c=a(b.target),h=c.val(),null!=(g=c.attr("name"))&&this.is_checkout_field(c)&&h&&h!==c.data("jilt-value")&&("account_username"===g&&(this.is_valid_email(a("#billing_email").val())&&(h=a("#billing_email").val()),g="billing_email"),("billing_email"!==g||this.is_valid_email(h))&&(d=0===g.indexOf("billing_")?"billing_address":"shipping_address",i=g.replace("billing_","").replace("shipping_",""),null!=(f=this.params.order_address_mapping[i]))))return e={},e.cart_token=this.params.cart_token,e[d]={},e[d][f]=h,"billing_address"===d&&["email","first_name","last_name"].indexOf(f)>-1&&(e.customer={},e.customer[f]=h),a.ajax({method:"PUT",url:this.params.endpoint+"/orders/"+this.params.order_id,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:e})},b.prototype.send_order_data_before_unload=function(){var b,c,d,e,f,g,h;g=this.params.endpoint+"/orders/"+this.params.order_id,c={},c.cart_token=this.params.cart_token,c.customer={},c.billing_address={},c.shipping_address={},e=this.params.order_address_mapping;for(h in e)d=e[h],b=a("input[name=billing_"+h+"]").val(),f=a("input[name=shipping_"+h+"]").val(),("email"!==h||this.is_valid_email(b)||(b=a("#account_username").val(),this.is_valid_email(b)))&&(b&&(c.billing_address[d]=b,["email","first_name","last_name"].indexOf(d)>-1&&(c.customer[d]=b)),f&&(c.shipping_address[d]=f));if(!(a.isEmptyObject(c.customer)&&a.isEmptyObject(c.billing_address)&&a.isEmptyObject(c.shipping_address)))return null!=navigator.sendBeacon?(c.auth_token=this.params.public_key,navigator.sendBeacon(g+"/beacon",new Blob([a.param(c)],{type:"application/x-www-form-urlencoded"}))):a.ajax({method:"PUT",url:g,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:c,async:!1,timeout:750})},b.prototype.is_checkout_field=function(a){var b;return null!=(b=a.attr("name"))&&(-1!==b.indexOf("billing_")||-1!==b.indexOf("shipping_")||"account_username"===b)},b.prototype.is_valid_email=function(a){return/[^\s@]+@[^\s@]+\.[^\s@]+/.test(a)},b.prototype.set_customer=function(b){return a.ajax({method:"POST",url:this.params.ajax_url.toString().replace("%%endpoint%%","jilt_set_customer"),data:{security:this.params.nonce,email:b.email,first_name:b.first_name,last_name:b.last_name},success:function(a){return function(b){if(0>=a.params.log_level)return console.log(b)}}(this),failure:function(a){return function(b){if(0>=a.params.log_level)return console.log(b)}}(this)})},b}(),window.wc_jilt=new WC_Jilt}).call(this);
